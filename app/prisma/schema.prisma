// ===========================
// Prisma Schema - MySQL
// ===========================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ---------------------------
// Core Reference Tables
// ---------------------------

model Account {
  id          Int     @id @default(autoincrement())
  name        String
  accountType String
  currency    String
  active      Boolean

  payTransactions          Transaction[] @relation("PayAccountTransactions")
  counterpartyTransactions Transaction[] @relation("CounterpartyAccountTransactions")

  balances Balance[]

  @@index([accountType])
}

model Balance {
  id     Int      @id @default(autoincrement())
  amount Decimal? @default(0.00) @db.Decimal(10, 2)
  date   DateTime

  accountId Int
  account   Account @relation(fields: [accountId], references: [id])

  transactionId Int         @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@index([accountId])
  @@index([transactionId])
}

model Store {
  id     Int     @id @default(autoincrement())
  name   String
  url    String?
  active Boolean

  transactions Transaction[]

  @@unique([name])
}

model Person {
  id     Int     @id @default(autoincrement())
  name   String
  active Boolean

  transactions Transaction[]
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String
  active Boolean

  parentCategoryId Int?
  parent           Category? @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])

  children Category[] @relation("CategoryHierarchy")

  products         Product[]
  transactionItems TransactionItem[]
}

model Product {
  id     Int     @id @default(autoincrement())
  name   String
  active Boolean

  categoryId Int
  category   Category @relation(fields: [categoryId], references: [id])

  variants ProductVariant[]

  @@index([categoryId])
}

model ProductVariant {
  id          Int     @id @default(autoincrement())
  productId   Int
  unitSize    Decimal @db.Decimal(10, 2)
  unitType    String
  description String?
  active      Boolean

  product Product           @relation(fields: [productId], references: [id])
  items   TransactionItem[]

  brands ProductVariantBrand[]

  @@unique([productId, unitSize, unitType])
  @@index([productId])
}

model Brand {
  id     Int     @id @default(autoincrement())
  name   String
  url    String?
  active Boolean

  items    TransactionItem[]
  variants ProductVariantBrand[]

  @@unique([name])
}

model ProductVariantBrand {
  variantId Int
  brandId   Int

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  brand   Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@id([variantId, brandId])
  @@index([brandId])
}

// ---------------------------
// Transactions & Items
// ---------------------------

model Transaction {
  id        Int      @id @default(autoincrement())
  date      DateTime
  type      String
  processed Boolean

  // Paying Account
  payAccountId Int?
  payAccount   Account? @relation("PayAccountTransactions", fields: [payAccountId], references: [id])

  // Receiving Account (CREDIT PAYMENT, SAVING, ...)
  counterpartyAccountId Int?
  counterpartyAccount   Account? @relation("CounterpartyAccountTransactions", fields: [counterpartyAccountId], references: [id])

  // Context
  storeId Int?
  store   Store? @relation(fields: [storeId], references: [id])

  personId Int?
  person   Person? @relation(fields: [personId], references: [id])

  // Totals for EXPENSE (required when type = expense)
  subtotal   Decimal? @default(0.00) @db.Decimal(10, 2)
  taxTotal   Decimal? @default(0.00) @db.Decimal(10, 2)
  grandTotal Decimal? @default(0.00) @db.Decimal(10, 2)

  // Simple amount for INCOME / CREDIT_PAYMENT / REFUND (required in those cases)
  amount Decimal? @default(0.00) @db.Decimal(10, 2)

  notes String?

  // Optional link: refunds referencing original expense
  refundOfId Int?
  refundOf   Transaction?  @relation("RefundRelation", fields: [refundOfId], references: [id])
  refunds    Transaction[] @relation("RefundRelation")

  items TransactionItem[]

  balance Balance?

  @@index([date])
  @@index([storeId])
  @@index([personId])
  @@index([payAccountId])
  @@index([counterpartyAccountId])
}

model TransactionItem {
  id          Int     @id @default(autoincrement())
  description String?
  // Pricing & quantities (minor units for money)
  quantity    Decimal @db.Decimal(10, 2) // supports weights (e.g., 0.5 kg)
  unitPrice   Decimal @default(0.00) @db.Decimal(10, 2)
  lineTotal   Decimal @default(0.00) @db.Decimal(10, 2)

  transactionId Int
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  variantId Int?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])

  categoryId Int?
  category   Category? @relation(fields: [categoryId], references: [id])

  brandId Int?
  brand   Brand? @relation(fields: [brandId], references: [id])

  @@index([transactionId])
  @@index([variantId])
  @@index([categoryId])
  @@index([brandId])
}
